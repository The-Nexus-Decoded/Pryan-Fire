name: Phantom Gauntlet Trial

on:
  pull_request:
    branches: [ master, main ]

jobs:
  phantom-trial:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          cd hughs-forge/meteora-trader
          npm install

      - name: Shift to Phantom Realm
        run: |
          # Use the Chasm-Shifter logic to enforce Devnet configuration
          chmod +x hughs-forge/scripts/switch_realm.sh
          ./hughs-forge/scripts/switch_realm.sh testnet

      - name: Execute Phantom Strike (1 Hour Trial)
        env:
          TRADING_WALLET_PUBLIC_KEY: ${{ secrets.DEVNET_WALLET_PUBLIC_KEY }}
          TRADING_WALLET_SECRET_KEY: ${{ secrets.DEVNET_WALLET_SECRET_KEY }}
          HELIUS_RPC_URL: "https://api.devnet.solana.com"
        run: |
          echo "‚öîÔ∏è Initiating Trial by Phantom Fire..."
          # The Trial by Fire: Execute the core logic and enforce a successful exit code.
          # We use a timeout to bound the trial to exactly 1 hour as Zifnab commanded.
          # Any non-zero exit from the Orchestrator or Trader will fail the entire Job.
          timeout 3600 python3 services/trade-orchestrator/src/TradeOrchestrator.py --config config/testnet/orchestrator_config.json || {
            echo "‚ùå THE SENTINEL HAS FALLEN. Trial failed with exit code $?."
            exit 1
          }
          echo "‚úÖ The Sentinel has survived the Hour of Fire."

      - name: Verify Audit Logs
        run: |
          echo "üîé Analyzing phantom audit logs for signs of failure..."
          # Scan for FATAL or CRITICAL errors in the generated logs.
          if grep -qE "FATAL|CRITICAL|ERROR" services/trade-orchestrator/logs/orchestrator.log; then
            echo "‚ùå DISCOVERY: Hidden flaws found in the audit logs."
            exit 1
          fi
          echo "‚úÖ Phantom trial passed. Logic is stable and pure."
