name: Phantom Gauntlet Trial

on:
  pull_request:
    branches: [ master, main ]

jobs:
  phantom-trial:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Node Dependencies
        run: |
          cd hughs-forge/meteora-trader
          npm install

      - name: Shift to Phantom Realm
        run: |
          chmod +x hughs-forge/scripts/switch_realm.sh
          ./hughs-forge/scripts/switch_realm.sh testnet

      - name: Python Import Smoke Test
        run: |
          echo "Verifying trade-orchestrator module imports..."
          cd hughs-forge/services/trade-orchestrator/src
          python3 -c "
          from core.orchestrator import TradeOrchestrator
          from core.event_loop import EventLoop
          from core.state_machine import TradeState
          from core.rpc_integration import RpcIntegrator
          from state.state_manager import TradeStateManager
          from telemetry.logger import setup_telemetry_logger
          print('All trade-orchestrator modules imported successfully.')
          "

      - name: Verify Orchestrator Startup (Dry Run)
        run: |
          echo "Starting orchestrator dry-run (5s timeout)..."
          cd hughs-forge/services/trade-orchestrator/src
          timeout 5 python3 main.py --db ":memory:" || {
            exit_code=$?
            if [ $exit_code -eq 124 ]; then
              echo "Orchestrator ran for 5s without crashing. Dry run PASSED."
              exit 0
            else
              echo "Orchestrator crashed with exit code $exit_code"
              exit 1
            fi
          }
          echo "Orchestrator exited cleanly."
