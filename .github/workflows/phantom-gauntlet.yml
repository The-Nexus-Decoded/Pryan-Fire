name: Phantom Gauntlet Trial

on:
  pull_request:
    branches: [ master, main ]

jobs:
  phantom-trial:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Node Dependencies
        run: |
          cd hughs-forge/meteora-trader
          npm install

      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install -r hughs-forge/services/trade-executor/requirements.txt

      - name: Shift to Phantom Realm
        run: |
          chmod +x hughs-forge/scripts/switch_realm.sh
          ./hughs-forge/scripts/switch_realm.sh testnet

      - name: TypeScript Compile Check
        run: |
          echo "Compiling meteora-trader TypeScript (PositionManager + PythHermesClient)..."
          cd hughs-forge/meteora-trader
          npx tsc --noEmit
          echo "TypeScript compilation passed."

      - name: Python Import Smoke Test
        run: |
          echo "Verifying trade-orchestrator module imports..."
          cd hughs-forge/services/trade-orchestrator/src
          python3 -c "
          from core.orchestrator import TradeOrchestrator
          from core.event_loop import EventLoop
          from core.state_machine import TradeState
          from core.rpc_integration import RpcIntegrator
          from state.state_manager import TradeStateManager
          from telemetry.logger import setup_telemetry_logger
          print('All trade-orchestrator modules imported successfully.')
          "

      - name: Risk Manager Unit Tests
        run: |
          echo "Running RiskManager unit tests..."
          cd hughs-forge/services/trade-executor
          python3 -m pytest test_risk_manager.py -v 2>/dev/null || python3 -m unittest test_risk_manager -v

      - name: Verify Orchestrator Startup (Dry Run)
        run: |
          echo "Starting orchestrator dry-run (5s timeout)..."
          cd hughs-forge/services/trade-orchestrator/src
          timeout 5 python3 main.py --db ":memory:" || {
            exit_code=$?
            if [ $exit_code -eq 124 ]; then
              echo "Orchestrator ran for 5s without crashing. Dry run PASSED."
              exit 0
            else
              echo "Orchestrator crashed with exit code $exit_code"
              exit 1
            fi
          }
          echo "Orchestrator exited cleanly."

      - name: Devnet Wallet Verification
        env:
          TRADING_WALLET_PUBLIC_KEY: ${{ secrets.DEVNET_WALLET_PUBLIC_KEY }}
        run: |
          echo "Verifying devnet wallet connectivity..."
          if [ -z "$TRADING_WALLET_PUBLIC_KEY" ]; then
            echo "DEVNET_WALLET_PUBLIC_KEY secret not set, skipping."
            exit 0
          fi
          RESPONSE=$(curl -s -X POST https://api.devnet.solana.com \
            -H "Content-Type: application/json" \
            -d "{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"getBalance\",\"params\":[\"$TRADING_WALLET_PUBLIC_KEY\"]}")
          echo "RPC Response: $RESPONSE"
          if echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'result' in d; print(f'Wallet balance: {d[\"result\"][\"value\"] / 1e9:.4f} SOL')"; then
            echo "Devnet wallet verified."
          else
            echo "WARNING: Could not verify wallet (devnet may be down). Non-blocking."
          fi
